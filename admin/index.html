<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  <title>TLCloudShop 管理后台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- 本地CDN依赖 -->
  <script src="/admin/cdn/jwt-decode.min.js"></script>
  <script src="/admin/cdn/bootstrap.bundle.min.js"></script>
  <script src="/admin/cdn/axios.min.js"></script>
  <script src="/admin/cdn/chart.js"></script>
  <link rel="stylesheet" href="./cdn/bootstrap.min.css">
  <style>
    body { background: #f8f9fa; }
    .container { margin-top: 40px; }
    .card { margin-bottom: 24px; }
    .table img { max-width: 60px; max-height: 60px; }
    .nav-tabs .nav-link.active { background: #e9ecef; }
    
    /* 图表容器样式，防止无限拉伸 */
    .chart-container {
      position: relative;
      height: 250px;
      width: 100%;
      overflow: hidden;
    }
    .chart-container-sm {
      position: relative;
      height: 100px;
      width: 100%;
      overflow: hidden;
    }
    /* 确保所有canvas在容器中保持正确比例 */
    canvas.chart-canvas {
      max-height: 100%;
      width: 100% !important;
    }
  </style>
</head>
<body>
<div class="container">
    <h2 class="mb-4 d-flex justify-content-between align-items-center">
      <span><i class="bi bi-shield-lock-fill me-2 text-primary"></i>TLCloudShop 管理后台</span>
      <button class="btn btn-outline-secondary btn-sm" id="logoutBtn">退出/切换账户</button>
    </h2>

    <!-- 统计卡片区 -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card border-start border-5 border-primary h-100 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="fs-5 fw-bold text-primary"><i class="bi bi-cart-check-fill me-2"></i>总订单数</span>
              <span id="totalOrders" class="fs-4">0</span>
            </div>
            <div class="small text-muted">今日新增：<span id="todayOrders">0</span></div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-start border-5 border-success h-100 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="fs-5 fw-bold text-success"><i class="bi bi-currency-yen me-2"></i>本月收入</span>
              <span id="monthRevenue" class="fs-5">￥0.00</span>
            </div>
            <div class="small text-muted">总收入：<span id="totalRevenue">￥0.00</span></div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-start border-5 border-info h-100 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="fs-5 fw-bold text-info"><i class="bi bi-clock-history me-2"></i>最晚下单</span>
              <span id="latestPending" class="fs-6"></span>
            </div>
            <div class="small text-muted">待处理订单：<span id="pendingOrders">0</span></div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-start border-5 border-warning h-100 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="fs-5 fw-bold text-warning"><i class="bi bi-exclamation-triangle me-2"></i>低库存商品</span>
              <span id="stockWarnings" class="fs-4">0</span>
            </div>
            <div class="small text-muted">请及时补货</div>
          </div>
        </div>
      </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="adminTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab"><i class="bi bi-speedometer2 me-1"></i>仪表盘</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="user-tab" data-bs-toggle="tab" data-bs-target="#user" type="button" role="tab"><i class="bi bi-person-lines-fill me-1"></i>用户管理</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="product-tab" data-bs-toggle="tab" data-bs-target="#product" type="button" role="tab"><i class="bi bi-box-seam me-1"></i>商品管理</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="category-tab" data-bs-toggle="tab" data-bs-target="#category" type="button" role="tab"><i class="bi bi-tags me-1"></i>分类管理</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="order-tab" data-bs-toggle="tab" data-bs-target="#order" type="button" role="tab"><i class="bi bi-receipt-cutoff me-1"></i>订单管理</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="cart-tab" data-bs-toggle="tab" data-bs-target="#cart" type="button" role="tab"><i class="bi bi-cart4 me-1"></i>购物车管理</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="notification-tab" data-bs-toggle="tab" data-bs-target="#notification" type="button" role="tab"><i class="bi bi-bell me-1"></i>通知管理</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab"><i class="bi bi-journal-text me-1"></i>系统日志</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="control-tab" data-bs-toggle="tab" data-bs-target="#control" type="button" role="tab"><i class="bi bi-gear-fill me-1"></i>参数配置</button>
      </li>
    </ul>
    <div class="tab-content" id="adminTabContent">
      <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-primary text-white fw-bold"><i class="bi bi-speedometer2 me-2"></i>系统概览</div>
          <div class="card-body p-3">
            <div class="row g-3">
              <!-- 仪表盘图表区域 -->
              <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-body">
                    <h5 class="card-title fw-bold mb-3">销售趋势</h5>
                    <div class="chart-container">
                      <canvas id="salesTrendChart" class="chart-canvas"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-body">
                    <h5 class="card-title fw-bold mb-3">热门商品</h5>
                    <div class="chart-container">
                      <canvas id="topProductsChart" class="chart-canvas"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 仪表盘数据区域 -->
              <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                  <div class="card-body">
                    <h5 class="card-title fw-bold mb-3">系统状态</h5>
                    <div class="mb-2">
                      <div class="d-flex justify-content-between align-items-center">
                        <span>CPU使用率</span>
                        <span class="badge bg-primary">30%</span>
                      </div>
                      <div class="progress" style="height: 8px;">
                        <div class="progress-bar" role="progressbar" style="width: 30%"></div>
                      </div>
                    </div>
                    <div class="mb-2">
                      <div class="d-flex justify-content-between align-items-center">
                        <span>内存使用率</span>
                        <span class="badge bg-success">45%</span>
                      </div>
                      <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 45%"></div>
                      </div>
                    </div>
                    <div class="mb-2">
                      <div class="d-flex justify-content-between align-items-center">
                        <span>磁盘使用率</span>
                        <span class="badge bg-warning">65%</span>
                      </div>
                      <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: 65%"></div>
                      </div>
                    </div>
                    <div class="mb-0">
                      <div class="d-flex justify-content-between align-items-center">
                        <span>系统运行时间</span>
                        <span class="badge bg-info">3天4小时</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                  <div class="card-body">
                    <h5 class="card-title fw-bold mb-3">待办事项</h5>
                    <ul class="list-group list-group-flush">
                      <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                        <span>待处理订单</span>
                        <span class="badge bg-danger rounded-pill">5</span>
                      </li>
                      <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                        <span>库存预警</span>
                        <span class="badge bg-warning rounded-pill">3</span>
                      </li>
                      <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                        <span>用户反馈</span>
                        <span class="badge bg-info rounded-pill">7</span>
                      </li>
                      <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                        <span>系统通知</span>
                        <span class="badge bg-primary rounded-pill">2</span>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                  <div class="card-body">
                    <h5 class="card-title fw-bold mb-3">快捷操作</h5>
                    <div class="d-grid gap-2">
                      <button class="btn btn-outline-primary" type="button">备份数据库</button>
                      <button class="btn btn-outline-success" type="button">导出订单报表</button>
                      <button class="btn btn-outline-info" type="button">刷新缓存</button>
                      <button class="btn btn-outline-warning" type="button">发送系统通知</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="tab-pane fade" id="user" role="tabpanel">
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-primary text-white fw-bold"><i class="bi bi-person-lines-fill me-2"></i>用户管理</div>
          <div class="card-body p-3">
            <div id="userTableWrap"></div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="product" role="tabpanel">
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-success text-white fw-bold"><i class="bi bi-box-seam me-2"></i>商品管理</div>
          <div class="card-body p-3">
            <div id="productTableWrap"></div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="order" role="tabpanel">
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-info text-white fw-bold"><i class="bi bi-receipt-cutoff me-2"></i>订单管理</div>
          <div class="card-body p-3">
            <div class="d-flex flex-wrap gap-2 mb-3">
              <button class="btn btn-primary d-flex align-items-center gap-2" id="addOrderBtn">
                <i class="bi bi-plus-lg"></i> 新增订单
              </button>
              <button class="btn btn-outline-secondary d-flex align-items-center gap-2" id="refreshOrders">
                <i class="bi bi-arrow-clockwise"></i> 刷新数据
              </button>
              <div class="ms-auto">
                <div class="input-group input-group-sm w-auto">
                  <span class="input-group-text">筛选:</span>
                  <select class="form-select" id="orderStatusFilter">
                    <option value="all">全部订单</option>
                    ${Object.entries(ORDER_STATUS_MAP).map(([k,v])=>`<option value="${k}">${v.label}</option>`).join('')}
                  </select>
                </div>
              </div>
            </div>
            <div id="orderTableWrap"></div>
            <div id="orderStats" class="mt-3 p-3 bg-light rounded-3 border">
              <div class="row g-3">
                <div class="col-md-4">
                  <h6 class="fw-bold mb-2"><i class="bi bi-pie-chart-fill me-1"></i>订单状态分布</h6>
                  <ul class="list-unstyled mb-0" id="orderStatusStats">
                    <!-- 动态生成 -->
                  </ul>
                </div>
                <div class="col-md-4">
                  <h6 class="fw-bold mb-2"><i class="bi bi-credit-card-2-front-fill me-1"></i>支付方式占比</h6>
                  <ul class="list-unstyled mb-0" id="paymentTypeStats">
                    <!-- 动态生成 -->
                  </ul>
                </div>
                <div class="col-md-4">
                  <h6 class="fw-bold mb-2"><i class="bi bi-graph-up-arrow me-1"></i>月度趋势</h6>
                  <div class="chart-container-sm">
                    <canvas id="monthlyChart" class="chart-canvas"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="cart" role="tabpanel">
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-warning text-dark fw-bold"><i class="bi bi-cart4 me-2"></i>购物车管理</div>
          <div class="card-body p-3">
            <div id="cartTableWrap"></div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="control" role="tabpanel">
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-secondary text-white fw-bold"><i class="bi bi-gear-fill me-2"></i>参数配置</div>
          <div class="card-body p-3">
            <div class="d-flex flex-wrap gap-2 mb-3">
              <button class="btn btn-success btn-sm" id="addConfigBtn"><i class="bi bi-plus-lg"></i> 新增配置</button>
              <button class="btn btn-outline-secondary btn-sm" id="refreshConfigBtn"><i class="bi bi-arrow-clockwise"></i> 刷新</button>
            </div>
            <div id="configTableWrap"></div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="category" role="tabpanel">
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-success text-white fw-bold"><i class="bi bi-tags me-2"></i>分类管理</div>
          <div class="card-body p-3">
            <div class="d-flex flex-wrap gap-2 mb-3">
              <button class="btn btn-primary btn-sm" id="addCategoryBtn"><i class="bi bi-plus-lg"></i> 添加分类</button>
              <button class="btn btn-outline-secondary btn-sm" id="refreshCategoriesBtn"><i class="bi bi-arrow-clockwise"></i> 刷新</button>
            </div>
            <div id="categoryTableWrap">
              <!-- 分类表格将通过JS动态加载 -->
              <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在加载分类数据...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="notification" role="tabpanel">
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-info text-white fw-bold"><i class="bi bi-bell me-2"></i>通知管理</div>
          <div class="card-body p-3">
            <div class="d-flex flex-wrap gap-2 mb-3">
              <button class="btn btn-primary btn-sm" id="addNotificationBtn"><i class="bi bi-plus-lg"></i> 发布通知</button>
              <button class="btn btn-outline-secondary btn-sm" id="refreshNotificationsBtn"><i class="bi bi-arrow-clockwise"></i> 刷新</button>
            </div>
            <div id="notificationTableWrap">
              <!-- 通知表格将通过JS动态加载 -->
              <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在加载通知数据...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="logs" role="tabpanel">
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-secondary text-white fw-bold"><i class="bi bi-journal-text me-2"></i>系统日志</div>
          <div class="card-body p-3">
            <div class="d-flex flex-wrap gap-2 mb-3">
              <div class="input-group input-group-sm" style="max-width: 300px;">
                <span class="input-group-text">日志类型</span>
                <select class="form-select" id="logTypeFilter">
                  <option value="all">全部日志</option>
                  <option value="error">错误日志</option>
                  <option value="info">信息日志</option>
                  <option value="warn">警告日志</option>
                  <option value="debug">调试日志</option>
                </select>
              </div>
              <button class="btn btn-outline-secondary btn-sm" id="refreshLogsBtn"><i class="bi bi-arrow-clockwise"></i> 刷新</button>
              <button class="btn btn-outline-danger btn-sm" id="clearLogsBtn"><i class="bi bi-trash"></i> 清除日志</button>
            </div>
            <div id="logsTableWrap">
              <!-- 日志表格将通过JS动态加载 -->
              <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在加载系统日志...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- 先加载admin.js核心API -->
<script src="admin.js"></script>
<!-- 加载渲染脚本 -->
<script src="render/dashboard.js"></script>
<script src="render/user.js"></script>
<script src="render/product.js"></script>
<script src="render/order.js"></script>
<script src="render/control.js"></script>
<script src="render/category.js"></script>
<script src="render/notification.js"></script>
<script src="render/logs.js"></script>
<script src="control.js"></script>
<!-- 将渲染逻辑延迟到DOM加载完成后执行 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // 页面初始化代码
  if (document.getElementById('orderTableWrap')) {
    window.loadOrderTable();
    document.getElementById('order-tab').addEventListener('click', window.loadOrderTable);
  }
  
  // 订单统计初始化
  if (document.getElementById('monthlyChart')) {
    loadOrderStats();
    document.getElementById('refreshOrders')?.addEventListener('click', () => {
      window.loadOrderTable();
      loadOrderStats();
    });
  }
});
</script>
<script>
document.getElementById('logoutBtn').onclick = function() {
  if (window.logoutAdmin) window.logoutAdmin();
};
</script>

<!-- 添加统计脚本 -->
<script>
  // 订单统计功能
  function updateOrderStats(orders) {
    // 状态统计
    const statusCounts = {};
    Object.keys(ORDER_STATUS_MAP).forEach(k => statusCounts[k] = 0);
    orders.forEach(o => statusCounts[o.order_status]++);
    
    const statusList = document.getElementById('orderStatusStats');
    statusList.innerHTML = '';
    Object.entries(statusCounts).forEach(([k, count]) => {
      if (count > 0) {
        statusList.innerHTML += `
          <li class="d-flex justify-content-between">
            <span>${ORDER_STATUS_MAP[k]?.label || '未知'}:</span>
            <span class="badge bg-${ORDER_STATUS_MAP[k]?.color || 'secondary'} rounded-pill">${count}</span>
          </li>
        `;
      }
    });
    
    // 支付类型统计
    const paymentCounts = {};
    Object.keys(PAY_TYPE_MAP).forEach(k => paymentCounts[k] = 0);
    orders.forEach(o => {
      const type = o.pay_type || 0;
      paymentCounts[type] = (paymentCounts[type] || 0) + 1;
    });
    
    const paymentList = document.getElementById('paymentTypeStats');
    paymentList.innerHTML = '';
    Object.entries(paymentCounts).forEach(([k, count]) => {
      if (count > 0) {
        paymentList.innerHTML += `
          <li class="d-flex justify-content-between">
            <span>${PAY_TYPE_MAP[k]?.label || '未知'}:</span>
            <span class="badge bg-${PAY_TYPE_MAP[k]?.color || 'secondary'} rounded-pill">${count}</span>
          </li>
        `;
      }
    });
    
    // 总览统计
    document.getElementById('totalOrders').textContent = orders.length;
    document.getElementById('todayOrders').textContent = orders.filter(o => {
      const today = new Date();
      return new Date(o.create_time).toDateString() === today.toDateString();
    }).length;
    
    // 计算总收入，只计算已支付的订单
    document.getElementById('totalRevenue').textContent = 
      '￥' + orders.filter(o => o.order_status === '1' || o.order_status === 1)
      .reduce((sum, o) => sum + parseFloat(o.pay_amount || 0), 0).toFixed(2);
    
    // 计算本月收入，只计算已支付的订单
    const currentDate = new Date();
    const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const monthRevenue = orders.filter(o => {
      return (o.order_status === '1' || o.order_status === 1) && 
             new Date(o.pay_time) >= firstDayOfMonth;
    }).reduce((sum, o) => sum + parseFloat(o.pay_amount || 0), 0);
    
    document.getElementById('monthRevenue').textContent = '￥' + monthRevenue.toFixed(2);
    
    // 近期订单统计
    const monthlyStats = {};
    const orderDate = new Date();
    for (let i = 0; i < 6; i++) {
      const date = new Date(orderDate);
      date.setMonth(date.getMonth() - i);
      monthlyStats[`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`] = 0;
    }
    
    orders.forEach(o => {
      const date = new Date(o.create_time);
      const key = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`;
      if (monthlyStats[key] !== undefined) {
        monthlyStats[key]++;
      }
    });
    
    // 创建图表
    const ctx = document.getElementById('monthlyChart').getContext('2d');
    if (window.monthlyChartInstance) {
      window.monthlyChartInstance.destroy();
      window.monthlyChartInstance = null;
    }
    // 修正：保证 labels 和 data 顺序一一对应
    const sortedKeys = Object.keys(monthlyStats).sort();
    const sortedValues = sortedKeys.map(k => monthlyStats[k]);
    window.monthlyChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: sortedKeys,
        datasets: [{
          label: '订单数量',
          data: sortedValues,
          borderColor: '#4e73df',
          backgroundColor: 'rgba(78, 115, 223, 0.05)',
          tension: 0.3,
          pointRadius: 2,
          pointBackgroundColor: '#4e73df'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { 
              stepSize: Math.ceil(Math.max(...Object.values(monthlyStats)) / 5),
              font: { size: 9 }
            },
            grid: {
              drawBorder: false
            }
          },
          x: {
            ticks: { font: { size: 9 } },
            grid: {
              display: false
            }
          }
        },
        elements: {
          line: { borderWidth: 2 }
        }
      }
    });
  }
  
  // 统计订单数据（在加载或刷新时调用）
  async function loadOrderStats() {
    try {
      // 使用正确的API路径获取数据
      const response = await fetch('/api/admin/getAllOrders', {
        headers: { 
          'Authorization': localStorage.getItem('token') ? 'Bearer ' + localStorage.getItem('token') : ''
        }
      });
      
      if (!response.ok) throw new Error('网络响应失败');
      
      const data = await response.json();
      if (data.success) {
        updateOrderStats(data.orders);
      } else {
        throw new Error(data.message || '获取订单数据失败');
      }
    } catch (err) {
      console.error('[loadOrderStats error]', err);
    }
  }
  
  // 快捷操作绑定
  document.getElementById('exportOrders')?.addEventListener('click', () => {
    alert('导出功能正在开发中...');
  });
  
  document.getElementById('printOrders')?.addEventListener('click', () => {
    window.print();
  });
</script>
</body>
</html>
